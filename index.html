<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Piano Scale Master</title>
    
    <link rel="manifest" href="manifest.json">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { 
            overscroll-behavior-y: contain;
            user-select: none; 
            -webkit-user-select: none; 
            touch-action: manipulation;
            background-color: #0f172a;
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }

        .white-key { width: 44px; height: 180px; transition: all 0.05s; }
        .black-key { width: 30px; height: 110px; margin-left: -15px; z-index: 10; }
        .key-pressed { transform: translateY(6px) !important; filter: brightness(0.9); }
        
        .piano-scroll-box {
            width: 100%;
            overflow-x: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        /* Landscape warning for mobile */
        @media screen and (orientation: portrait) {
            #portrait-warning { display: flex; }
        }
        #portrait-warning {
            display: none;
            position: fixed;
            inset: 0;
            background: #1e293b;
            color: white;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
    </style>

    <script>
        // Service Worker registration using absolute path logic for GitHub Pages
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swPath = window.location.pathname.endsWith('/') 
                    ? 'sw.js' 
                    : window.location.pathname.split('/').pop() === 'index.html' 
                        ? 'sw.js' 
                        : './sw.js';
                navigator.serviceWorker.register(swPath)
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Failed', err));
            });
        }
    </script>
</head>
<body>
    <div id="portrait-warning">
        <div class="text-4xl mb-4">üîÑ</div>
        <p>Please rotate your phone to Landscape mode to play!</p>
    </div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const PianoScaleGame = () => {
          const [score, setScore] = useState(0);
          const [lives, setLives] = useState(3);
          const [currentStep, setCurrentStep] = useState(0);
          const [showLabels, setShowLabels] = useState(true);
          const audioContextRef = useRef(null);

          useEffect(() => {
            audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
          }, []);

          const notes = [
            { note: 'C', freq: 261.63, isBlack: false, oct: 1 }, { note: 'C#', freq: 277.18, isBlack: true, oct: 1 },
            { note: 'D', freq: 293.66, isBlack: false, oct: 1 }, { note: 'D#', freq: 311.13, isBlack: true, oct: 1 },
            { note: 'E', freq: 329.63, isBlack: false, oct: 1 }, { note: 'F', freq: 349.23, isBlack: false, oct: 1 },
            { note: 'F#', freq: 369.99, isBlack: true, oct: 1 }, { note: 'G', freq: 392.00, isBlack: false, oct: 1 },
            { note: 'G#', freq: 415.30, isBlack: true, oct: 1 }, { note: 'A', freq: 440.00, isBlack: false, oct: 1 },
            { note: 'A#', freq: 466.16, isBlack: true, oct: 1 }, { note: 'B', freq: 493.88, isBlack: false, oct: 1 },
            { note: 'C', freq: 523.25, isBlack: false, oct: 2 }, { note: 'C#', freq: 554.37, isBlack: true, oct: 2 },
            { note: 'D', freq: 587.33, isBlack: false, oct: 2 }, { note: 'D#', freq: 622.25, isBlack: true, oct: 2 },
            { note: 'E', freq: 659.25, isBlack: false, oct: 2 }, { note: 'F', freq: 698.46, isBlack: false, oct: 2 },
            { note: 'F#', freq: 739.99, isBlack: true, oct: 2 }, { note: 'G', freq: 783.99, isBlack: false, oct: 2 },
            { note: 'G#', freq: 830.61, isBlack: true, oct: 2 }, { note: 'A', freq: 880.00, isBlack: false, oct: 2 },
            { note: 'A#', freq: 932.33, isBlack: true, oct: 2 }, { note: 'B', freq: 987.77, isBlack: false, oct: 2 },
            { note: 'C', freq: 1046.50, isBlack: false, oct: 3 },
            { note: 'C#', freq: 1108.73, isBlack: true, oct: 3 }
          ];

          const currentScale = { name: 'F Major Scale', sequence: ['F', 'G', 'A', 'A#', 'C', 'D', 'E', 'F'] };

          const playNote = (f) => {
            if (audioContextRef.current.state === 'suspended') audioContextRef.current.resume();
            const ctx = audioContextRef.current;
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            osc.frequency.value = f;
            g.gain.setValueAtTime(0.2, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start(); osc.stop(ctx.currentTime + 0.5);
          };

          const handlePress = (n) => {
            playNote(n.freq);
            if (n.note === currentScale.sequence[currentStep]) {
              if (currentStep === currentScale.sequence.length - 1) {
                setCurrentStep(0); setScore(s => s + 50);
              } else {
                setCurrentStep(s => s + 1); setScore(s => s + 10);
              }
            } else {
              setLives(l => Math.max(0, l - 1));
            }
          };

          const whiteNotes = notes.filter(n => !n.isBlack);
          const blackNotes = notes.filter(n => n.isBlack);

          return (
            <div className="h-screen w-screen flex flex-col bg-slate-900 text-white overflow-hidden">
              <div className="flex justify-between items-center px-6 py-2 bg-slate-800 border-b border-slate-700">
                <div className="flex items-center gap-4">
                    <div className="bg-indigo-600 px-3 py-1 rounded-full text-xs font-black tracking-tighter">SCORE: {score}</div>
                    <div className="text-sm">{"‚ù§Ô∏è".repeat(lives)}</div>
                </div>
                
                <div className="flex gap-1">
                  {currentScale.sequence.map((n, i) => (
                    <div key={i} className={`w-7 h-7 flex items-center justify-center rounded-lg text-[10px] font-bold transition-all ${i === currentStep ? 'bg-yellow-400 text-black scale-110 shadow-lg ring-2 ring-yellow-200' : i < currentStep ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-400 border border-slate-600'}`}>
                      {n}
                    </div>
                  ))}
                </div>

                <button onClick={() => setShowLabels(!showLabels)} className="text-[9px] font-bold px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded-full border border-slate-500 uppercase tracking-widest transition-colors">
                    Labels: {showLabels ? 'ON' : 'OFF'}
                </button>
              </div>

              <div className="flex-grow flex items-center justify-center overflow-x-auto">
                <div className="piano-scroll-box">
                  <div className="relative inline-block bg-slate-950 p-6 pt-14 rounded-[30px] shadow-2xl border-t-[10px] border-slate-800 ring-4 ring-black/50">
                    <div className="flex relative bg-slate-600 p-[1px] rounded-sm">
                      {whiteNotes.map((n, i) => (
                        <div key={i} onClick={() => handlePress(n)} className="white-key bg-white border-r border-slate-200 active:key-pressed cursor-pointer flex items-end justify-center pb-4 rounded-b-lg shadow-[inset_0_-8px_0_#e2e8f0,0_4px_0_#000]">
                          {showLabels && <span className="text-[9px] font-black text-slate-400 uppercase select-none">{n.note}{n.oct}</span>}
                        </div>
                      ))}

                      <div className="absolute top-0 left-0 w-full h-0 pointer-events-none">
                        {whiteNotes.map((_, i) => {
                          const pattern = [0, 1, 3, 4, 5]; 
                          const isLast = i === whiteNotes.length - 1;
                          if (pattern.includes(i % 7) || isLast) {
                            const oct = Math.floor(i / 7) + 1;
                            let noteName = ['C#','D#','F#','G#','A#'][pattern.indexOf(i % 7)] || 'C#';
                            const blackNoteObj = blackNotes.find(bn => bn.note === noteName && bn.oct === (isLast ? 3 : oct));
                            if (!blackNoteObj) return null;
                            return (
                              <div key={i} onClick={(e) => { e.stopPropagation(); handlePress(blackNoteObj); }} style={{ left: `${(i + 1) * 44}px` }}
                                className="black-key absolute top-0 pointer-events-auto bg-gradient-to-b from-slate-700 via-slate-900 to-black active:key-pressed rounded-b-md shadow-xl border-x border-slate-950 flex items-end justify-center pb-4">
                                {showLabels && <span className="text-[8px] font-bold text-slate-500 select-none">{blackNoteObj.note}</span>}
                              </div>
                            );
                          }
                          return null;
                        })}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        ReactDOM.render(<PianoScaleGame />, document.getElementById('root'));
    </script>
</body>
</html>
